<template>
	<div
		ref="container"
		:class="'k-block-container-type-' + type"
		:data-batched="isBatched"
		:data-disabled="fieldset.disabled"
		:data-hidden="isHidden"
		:data-id="id"
		:data-last-selected="isLastSelected"
		:data-selected="isSelected"
		:data-translate="fieldset.translate"
		class="k-block-container"
		tabindex="0"
		@keydown.meta.j.prevent="$emit('merge')"
		@keydown.ctrl.j.prevent="$emit('merge')"
		@keydown.meta.up.exact.prevent="$emit('focusPrev')"
		@keydown.ctrl.up.exact.prevent="$emit('focusPrev')"
		@keydown.meta.down.exact.prevent="$emit('focusNext')"
		@keydown.ctrl.down.exact.prevent="$emit('focusNext')"
		@keydown.meta.alt.down.prevent="$emit('selectDown')"
		@keydown.ctrl.alt.down.prevent="$emit('selectDown')"
		@keydown.meta.alt.up.prevent="$emit('selectUp')"
		@keydown.ctrl.alt.up.prevent="$emit('selectUp')"
		@keydown.meta.shift.down.prevent="$emit('sortDown')"
		@keydown.ctrl.shift.down.prevent="$emit('sortDown')"
		@keydown.meta.shift.up.prevent="$emit('sortUp')"
		@keydown.ctrl.shift.up.prevent="$emit('sortUp')"
		@keydown.meta.backspace.prevent="confirmToRemove"
		@keydown.ctrl.backspace.prevent="confirmToRemove"
		@focus="$emit('focus')"
		@focusin="onFocusIn"
	>
		<div :class="className" class="k-block">
			<component
				:is="customComponent"
				ref="editor"
				v-bind="$props"
				v-on="listeners"
			/>
		</div>

		<k-block-options
			ref="options"
			:is-batched="isBatched"
			:is-editable="isEditable"
			:is-full="isFull"
			:is-hidden="isHidden"
			:is-mergable="isMergable"
			:is-splitable="isSplitable()"
			v-on="{
				...listeners,
				split: () => $refs.editor.split()
			}"
		/>

		<k-form-drawer
			v-if="isEditable && !isBatched"
			:id="id"
			ref="drawer"
			:icon="fieldset.icon || 'box'"
			:tabs="tabs"
			:title="fieldset.name"
			:value="content"
			class="k-block-drawer"
			@close="
				focus();
				$emit('close');
			"
			@input="$emit('update', $event)"
			@open="$emit('open')"
		>
			<template #options>
				<k-button
					v-if="isHidden"
					class="k-drawer-option"
					icon="hidden"
					@click="$emit('show')"
				/>
				<k-button
					:disabled="!prev"
					class="k-drawer-option"
					icon="angle-left"
					@click.prevent.stop="goTo(prev)"
				/>
				<k-button
					:disabled="!next"
					class="k-drawer-option"
					icon="angle-right"
					@click.prevent.stop="goTo(next)"
				/>
				<k-button
					class="k-drawer-option"
					icon="trash"
					@click.prevent.stop="confirmToRemove"
				/>
			</template>
		</k-form-drawer>

		<k-remove-dialog
			ref="removeDialog"
			:text="$t('field.blocks.delete.confirm')"
			@submit="remove"
		/>
	</div>
</template>

<script>
export default {
	inheritAttrs: false,
	props: {
		attrs: [Array, Object],
		content: [Array, Object],
		endpoints: Object,
		fieldset: Object,
		id: String,
		isBatched: Boolean,
		isFull: Boolean,
		isHidden: Boolean,
		isLastSelected: Boolean,
		isMergable: Boolean,
		isSelected: Boolean,
		name: String,
		next: Object,
		prev: Object,
		type: String
	},
	data() {
		return {
			skipFocus: false
		};
	},
	computed: {
		className() {
			let className = ["k-block-type-" + this.type];

			if (this.fieldset.preview !== this.type) {
				className.push("k-block-type-" + this.fieldset.preview);
			}

			if (this.wysiwyg === false) {
				className.push("k-block-type-default");
			}

			return className;
		},
		customComponent() {
			if (this.wysiwyg) {
				return this.wysiwygComponent;
			}

			return "k-block-type-default";
		},
		isEditable() {
			return this.fieldset.editable !== false;
		},
		listeners() {
			return {
				...this.$listeners,
				confirmToRemove: this.confirmToRemove,
				open: this.open
			};
		},
		tabs() {
			let tabs = this.fieldset.tabs;

			Object.entries(tabs).forEach(([tabName, tab]) => {
				Object.entries(tab.fields).forEach(([fieldName]) => {
					tabs[tabName].fields[fieldName].section = this.name;
					tabs[tabName].fields[fieldName].endpoints = {
						field:
							this.endpoints.field +
							"/fieldsets/" +
							this.type +
							"/fields/" +
							fieldName,
						section: this.endpoints.section,
						model: this.endpoints.model
					};
				});
			});

			return tabs;
		},
		wysiwyg() {
			return this.wysiwygComponent !== false;
		},
		wysiwygComponent() {
			if (this.fieldset.preview === false) {
				return false;
			}

			let component;

			// custom preview
			if (this.fieldset.preview) {
				component = "k-block-type-" + this.fieldset.preview;

				if (this.$helper.isComponent(component)) {
					return component;
				}
			}

			// default preview
			component = "k-block-type-" + this.type;

			if (this.$helper.isComponent(component)) {
				return component;
			}

			return false;
		}
	},
	methods: {
		close() {
			this.$refs.drawer.close();
		},
		confirmToRemove() {
			this.$refs.removeDialog.open();
		},
		focus() {
			if (this.skipFocus !== true) {
				if (typeof this.$refs.editor.focus === "function") {
					this.$refs.editor.focus();
				} else {
					this.$refs.container.focus();
				}
			}
		},
		goTo(block) {
			if (block) {
				this.skipFocus = true;
				this.close();

				this.$nextTick(() => {
					block.$refs.container.focus();
					block.open();
					this.skipFocus = false;
				});
			}
		},
		isSplitable() {
			if (this.$refs.editor) {
				return (
					(this.$refs.editor.isSplitable ?? true) &&
					typeof this.$refs.editor?.split === "function"
				);
			}

			return false;
		},
		onFocusIn(event) {
			// skip focus if the event is coming from the options buttons
			// to preserve the current focus (since options buttons directly
			// trigger events and don't need any focus themselves)
			if (this.$refs.options?.$el?.contains(event.target)) {
				return;
			}

			this.$emit("focus", event);
		},
		open() {
			this.$refs.drawer?.open();
		},
		remove() {
			this.$refs.removeDialog.close();
			this.$emit("remove", this.id);
		}
	}
};
</script>

<style>
.k-block-container {
	position: relative;
	padding: 0.75rem;
	background: var(--color-white);
	border-radius: var(--rounded);
}
.k-block-container:not(:last-of-type) {
	border-bottom: 1px dashed rgba(0, 0, 0, 0.1);
}
.k-block-container:focus {
	outline: 0;
}

.k-block-container[data-selected="true"] {
	z-index: 2;
	border-bottom-color: transparent;
	box-shadow: var(--color-focus) 0 0 0 1px, var(--color-focus-outline) 0 0 0 3px;
}
.k-block-container[data-batched="true"]::after {
	position: absolute;
	inset: 0;
	content: "";
	background: hsl(214 33% 77% / 0.175);
	mix-blend-mode: multiply;
}

.k-block-container .k-block-options {
	display: none;
	position: absolute;
	top: 0;
	inset-inline-end: 0.75rem;
	margin-top: calc(-1.75rem + 2px);
}
.k-block-container[data-last-selected="true"] > .k-block-options {
	display: flex;
}
.k-block-container[data-hidden="true"] .k-block {
	opacity: 0.25;
}
.k-drawer-options .k-button[data-disabled="true"] {
	vertical-align: middle;
	display: inline-grid;
}
[data-disabled="true"] .k-block-container {
	background: var(--color-background);
}
</style>
